<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIREKAP v7.4 - Fix Dropdown HP</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --success-light: #dcfce7;
            --success-text: #15803d;
            --purple: #9333ea;
            --purple-light: #f3e8ff;
            --purple-text: #7e22ce;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --warning-text: #b45309;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text-main); padding-bottom: 60px; }

        /* Login & Setup Overlay */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-dark); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .box { background: white; padding: 2rem; border-radius: 16px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .box h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .box p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }
        
        .role-btn { width: 100%; padding: 1rem; margin-bottom: 1rem; border: 2px solid var(--border); border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .role-btn:hover { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .role-btn.admin { border-color: var(--primary); color: var(--primary); }
        
        /* Header */
        header { background-color: var(--primary-dark); color: white; padding: 1rem 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo h1 { font-size: 1.25rem; font-weight: 700; }
        
        .nav-buttons { display: flex; gap: 8px; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 8px; overflow-x: auto; }
        .nav-btn { background: transparent; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; }
        .nav-btn.active { background: white; color: var(--primary-dark); }

        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 1.5rem; }
        
        /* Stats & Table */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { display: flex; align-items: center; gap: 1rem; padding: 1.5rem; background: white; border-radius: 12px; border: 1px solid var(--border); }
        .stat-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .icon-blue { background: #eff6ff; color: var(--primary); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .stat-label { font-size: 0.875rem; color: var(--text-muted); font-weight: 600; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { text-align: left; padding: 1rem; background: #f1f5f9; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; }

        /* --- CUSTOM AUTOCOMPLETE DROPDOWN STYLES --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1rem; position: relative; } /* Relative for dropdown positioning */
        
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); ring: 2px solid #eff6ff; }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--primary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }
        .autocomplete-list.show { display: block; }
        
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
            color: #334155;
        }
        .autocomplete-item:hover, .autocomplete-item.active {
            background-color: #eff6ff;
            color: var(--primary);
            font-weight: 600;
        }
        .autocomplete-empty {
            padding: 12px 15px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* --- END CUSTOM DROPDOWN --- */
        
        .mode-selector { display: flex; gap: 1rem; }
        .mode-option { flex: 1; }
        .mode-option input { display: none; }
        .mode-label { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); }
        .mode-option input:checked + .mode-label.sendiri { background: var(--success-light); color: var(--success-text); border-color: var(--success); }
        .mode-option input:checked + .mode-label.berdua { background: var(--purple-light); color: var(--purple-text); border-color: var(--purple); }

        .btn-submit { width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 1rem; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }

        .btn-excel { width: 100%; padding: 1rem; background: #16a34a; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 1rem; text-decoration: none; }
        .btn-excel:hover { background: #15803d; }

        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* API Setup Box */
        .api-setup { background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bfdbfe; text-align: left; }
        .api-setup input { margin-top: 5px; background: white; margin-bottom: 10px; }
        .api-setup label { font-size: 0.85rem; color: #1e40af; }
        
        .hidden { display: none !important; }
        
        /* Master Data Styles */
        .master-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .master-section { background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); }
        .master-section h3 { margin-bottom: 1rem; font-size: 1rem; color: var(--text-main); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }
        .master-list { list-style: none; max-height: 300px; overflow-y: auto; background: white; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }
        .master-item { padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .master-item:last-child { border-bottom: none; }
        .input-group { display: flex; gap: 8px; }
        .btn-mini { padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; color: white; font-weight: 600; margin-left: 4px; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-sendiri { background: var(--success-light); color: var(--success-text); }
        .badge-berdua { background: var(--purple-light); color: var(--purple-text); }
        
        #notification { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 8px; transform: translateY(-150%); transition: transform 0.3s ease-out; z-index: 200; font-weight: 600; }
        #notification.show { transform: translateY(0); }

        /* Sync Status */
        .sync-status { font-size: 0.8rem; color: #64748b; margin-top: 5px; font-weight: bold; }
        .sync-status.unsaved { color: #ef4444; }

        @media (max-width: 768px) {
            .form-row, .master-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 1rem; }
            .nav-buttons { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- Setup & Login Overlay -->
    <div id="overlay">
        <div class="box" id="setup-box">
            <h2>‚öôÔ∏è Setup Koneksi</h2>
            <p>Masukkan Link agar aplikasi terhubung ke Cloud.</p>
            
            <div class="api-setup">
                <label>1. Link Web App (Google Script) *Wajib</label>
                <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/..../exec">
                
                <label>2. Link Spreadsheet (Excel) *Wajib utk Kepsek</label>
                <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
            </div>

            <button class="btn-submit" onclick="saveSettings()">Simpan & Lanjut</button>
            <button onclick="cancelSetup()" style="margin-top:10px; background:none; border:none; color:#64748b; cursor:pointer; font-size:0.9rem;">Batal</button>
        </div>

        <div class="box hidden" id="login-box">
            <h2>SIREKAP v7.4</h2>
            <p>Pilih akses masuk:</p>
            <button class="role-btn" onclick="login('guru')">üë®‚Äçüè´ Masuk sebagai GURU</button>
            <button class="role-btn admin" onclick="login('admin')">üîê Masuk sebagai KEPALA SEKOLAH</button>
            
            <div id="password-area" class="hidden" style="margin-top: 15px; text-align: left;">
                <label>Password Admin</label>
                <input type="password" id="adminPass" style="margin-bottom: 10px;" placeholder="Masukkan password...">
                <button class="btn-submit" onclick="checkAdmin()">Masuk Admin</button>
            </div>

             <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button onclick="showSetup()" style="background:none; border:none; color:#64748b; font-size:0.85rem; cursor:pointer; text-decoration:underline; display:flex; align-items:center; justify-content:center; width:100%; gap:6px;">
                    ‚öôÔ∏è Edit Koneksi Server
                </button>
            </div>
        </div>
    </div>

    <div id="notification">Berhasil!</div>

    <header>
        <div class="header-content">
            <div class="logo">
                <h1 style="font-size: 1.5rem;">SIREKAP</h1>
                <p id="connection-status">üü° Offline Mode</p>
            </div>
            <!-- Menu Admin -->
            <div class="nav-buttons hidden" id="admin-nav">
                <button class="nav-btn active" onclick="switchView('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="switchView('master')">Data Master</button>
                <button class="nav-btn" style="background: #ef4444;" onclick="logout()">Keluar</button>
            </div>
            <!-- Menu Guru -->
            <div class="nav-buttons hidden" id="guru-nav">
                <span style="color:white; font-weight:bold; padding:8px;">Mode Guru</span>
                <button class="nav-btn" style="background: #ef4444;" onclick="logout()">Keluar</button>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- DASHBOARD (ADMIN ONLY) -->
        <div id="view-dashboard" class="hidden">
            <a id="btn-open-sheet" href="#" target="_blank" class="btn-excel hidden">
                üìÇ Buka Database (Google Sheet)
            </a>

            <div class="card" style="text-align: right;">
                <button class="nav-btn" style="background: #2563eb; color: white;" onclick="fetchCloudData()">üîÑ Refresh Data Cloud</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon icon-blue">üïí</div>
                    <div>
                        <div class="stat-label">Total Jam</div>
                        <div class="stat-value" id="total-hours">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f0fdf4; color: #16a34a;">üë§</div>
                    <div>
                        <div class="stat-label">Sendiri</div>
                        <div class="stat-value" id="total-solo">0</div>
                    </div>
                </div>
                 <div class="stat-card">
                    <div class="stat-icon" style="background: #faf5ff; color: #9333ea;">üë•</div>
                    <div>
                        <div class="stat-label">Team</div>
                        <div class="stat-value" id="total-team">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Data Masuk (Real-time)</h2>
                <div id="loading-indicator" class="hidden" style="text-align: center; padding: 20px; color: #64748b;">
                    <span class="loader" style="border-color: #64748b; border-bottom-color: transparent;"></span> Sedang mengambil data...
                </div>
                <div class="table-responsive">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Guru</th>
                                <th>Mapel/Kelas</th>
                                <th>Mode</th>
                                <th>Jam</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DATA MASTER (ADMIN ONLY) -->
        <div id="view-master" class="hidden">
            <div class="card">
                <div class="flex-between" style="border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1rem;">
                    <div>
                        <h2>Kelola Data Master Sekolah</h2>
                        <p class="sync-status" id="master-sync-status">Status: Aman</p>
                    </div>
                    <button class="btn-submit" style="width:auto; margin:0; background:#16a34a;" onclick="uploadMasterData()">
                        üíæ Simpan Perubahan ke Cloud
                    </button>
                </div>

                <div class="master-grid">
                    <!-- Guru Master -->
                    <div class="master-section">
                        <h3>üë®‚Äçüè´ Daftar Guru</h3>
                        <div class="input-group">
                            <input type="text" id="newTeacherInput" placeholder="Tambah Guru Baru...">
                            <button class="btn-submit" style="margin:0; width:auto; padding:0 15px;" onclick="addMasterItem('teachers', 'newTeacherInput')">+</button>
                        </div>
                        <ul class="master-list" id="master-teacher-list"></ul>
                    </div>

                    <!-- Mapel Master -->
                    <div class="master-section">
                        <h3>üìö Daftar Mata Pelajaran</h3>
                        <div class="input-group">
                            <input type="text" id="newSubjectInput" placeholder="Tambah Mapel Baru...">
                            <button class="btn-submit" style="margin:0; width:auto; padding:0 15px;" onclick="addMasterItem('subjects', 'newSubjectInput')">+</button>
                        </div>
                        <ul class="master-list" id="master-subject-list"></ul>
                    </div>

                    <!-- Kelas Master -->
                    <div class="master-section">
                        <h3>üè´ Daftar Kelas</h3>
                        <div class="input-group">
                            <input type="text" id="newClassInput" placeholder="Tambah Kelas Baru...">
                            <button class="btn-submit" style="margin:0; width:auto; padding:0 15px;" onclick="addMasterItem('classes', 'newClassInput')">+</button>
                        </div>
                        <ul class="master-list" id="master-class-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM INPUT (GURU ONLY) -->
        <div id="view-form" class="hidden">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Form Absensi Online</h2>
                    <div style="display:flex; gap:5px;">
                        <button id="btn-update-guru" onclick="downloadMasterData(true)" style="background:#f1f5f9; border:1px solid #cbd5e1; padding:8px 12px; border-radius:6px; font-size:0.8rem; cursor:pointer; color:#334155; font-weight:600;">üîÑ Update Nama</button>
                        <button onclick="forceResetDefaults()" style="background:#fef2f2; border:1px solid #fee2e2; padding:8px 12px; border-radius:6px; font-size:0.8rem; cursor:pointer; color:#ef4444; font-weight:600;">‚ö†Ô∏è Reset</button>
                    </div>
                </div>
                <p style="font-size:0.8rem; color:#64748b; margin-top:-10px; margin-bottom:1rem;">Ketuk kolom untuk memilih dari daftar.</p>
                
                <form onsubmit="handleFormSubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Waktu Mulai</label>
                            <input type="time" id="startTime" required>
                        </div>
                    </div>

                    <!-- CUSTOM DROPDOWN GURU -->
                    <div class="form-group" id="group-teacher">
                        <label>Nama Guru</label>
                        <input type="text" id="teacherName" placeholder="Ketik atau Pilih Nama..." autocomplete="off" required>
                        <ul class="autocomplete-list" id="list-teacher"></ul>
                    </div>

                    <div class="form-row">
                        <!-- CUSTOM DROPDOWN MAPEL -->
                        <div class="form-group" id="group-subject">
                            <label>Mata Pelajaran</label>
                            <input type="text" id="subject" placeholder="Ketik/Pilih..." autocomplete="off" required>
                            <ul class="autocomplete-list" id="list-subject"></ul>
                        </div>
                        
                        <!-- CUSTOM DROPDOWN KELAS -->
                        <div class="form-group" id="group-class">
                            <label>Kelas</label>
                            <input type="text" id="className" placeholder="Ketik/Pilih..." autocomplete="off" required>
                            <ul class="autocomplete-list" id="list-class"></ul>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Jumlah Jam (JP)</label>
                            <input type="number" id="hours" min="1" max="10" value="2" required>
                        </div>
                        <div class="form-group">
                            <label>Mode</label>
                            <div class="mode-selector">
                                <div class="mode-option">
                                    <input type="radio" name="type" id="t-sendiri" value="sendiri" checked>
                                    <label for="t-sendiri" class="mode-label sendiri">üë§ Sendiri</label>
                                </div>
                                <div class="mode-option">
                                    <input type="radio" name="type" id="t-berdua" value="berdua">
                                    <label for="t-berdua" class="mode-label berdua">üë• Team</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                         <label style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="isSubstitute"> Guru Pengganti (Badal)
                        </label>
                    </div>

                    <button type="submit" id="btn-save" class="btn-submit">
                        <span id="btn-text">Kirim ke Cloud ‚òÅÔ∏è</span>
                        <span id="btn-loader" class="loader hidden"></span>
                    </button>
                </form>
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        let API_URL = localStorage.getItem('guru_api_url') || "https://script.google.com/macros/s/AKfycbx6QpLttVeXSHdovQJRgwccd1xTHrbNqMpP07-xeu-TfAcQQOzVheQsvJEYJ2feUJsi/exec";
        let SHEET_URL = localStorage.getItem('guru_sheet_url') || "https://docs.google.com/spreadsheets/d/18cRCNqXK860SYVmTDjlyabnL6fgh2sWdTMEG3_Ahpyw/edit?usp=sharing";
        const ADMIN_PASS = "admin123";
        let currentUserRole = null;

        // DATA MASTER DEFAULT
        const defaultTeachers = ["Budi Santoso", "Siti Aminah", "Ahmad Fauzi"];
        const defaultSubjects = ["Matematika", "B. Indonesia", "B. Inggris", "IPA", "IPS", "PPKn", "PJOK", "PAI", "Tahfidz"];
        const defaultClasses = ["1A Putra", "1B Putra", "1A Putri", "1B Putri", "7 Putra", "7 Putri"];

        let appData = {
            teachers: [],
            subjects: [],
            classes: []
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('startTime').value = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');

            if(API_URL) document.getElementById('apiUrl').value = API_URL;
            if(SHEET_URL) document.getElementById('sheetUrl').value = SHEET_URL;

            // Load local backup or Defaults
            loadLocalMaster();

            if(API_URL) {
                document.getElementById('setup-box').classList.add('hidden');
                document.getElementById('login-box').classList.remove('hidden');
                document.getElementById('connection-status').textContent = "üü¢ Online Connected";
                // Auto sync master data on load
                downloadMasterData();
            }

            // SETUP CUSTOM AUTOCOMPLETE HANDLERS
            setupAutocomplete('teacherName', 'list-teacher', 'teachers');
            setupAutocomplete('subject', 'list-subject', 'subjects');
            setupAutocomplete('className', 'list-class', 'classes');
        });

        // --- CUSTOM DROPDOWN LOGIC ---
        function setupAutocomplete(inputId, listId, dataKey) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);

            // 1. Show all on focus
            input.addEventListener('focus', () => {
                renderDropdown(list, appData[dataKey], input);
                list.classList.add('show');
            });

            // 2. Filter on type
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                const filtered = appData[dataKey].filter(item => item.toLowerCase().includes(query));
                renderDropdown(list, filtered, input);
                list.classList.add('show');
            });

            // 3. Hide on click outside (blur needs delay to allow click on item)
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.remove('show');
                }
            });
        }

        function renderDropdown(listElement, items, inputElement) {
            listElement.innerHTML = '';
            if (items.length === 0) {
                listElement.innerHTML = '<li class="autocomplete-empty">Tidak ada data. Ketik untuk tambah baru.</li>';
                return;
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'autocomplete-item';
                li.textContent = item;
                li.addEventListener('click', () => {
                    inputElement.value = item;
                    listElement.classList.remove('show');
                });
                listElement.appendChild(li);
            });
        }

        // --- MASTER DATA FUNCTIONS ---
        function loadLocalMaster() {
            const localT = JSON.parse(localStorage.getItem('master_teachers'));
            const localS = JSON.parse(localStorage.getItem('master_subjects'));
            const localC = JSON.parse(localStorage.getItem('master_classes'));

            appData.teachers = (localT && localT.length > 0) ? localT : defaultTeachers;
            appData.subjects = (localS && localS.length > 0) ? localS : defaultSubjects;
            appData.classes = (localC && localC.length > 0) ? localC : defaultClasses;

            renderMasterLists(); // For Admin
        }

        function forceResetDefaults() {
            if(confirm("Reset data lokal ke default?")) {
                appData.teachers = defaultTeachers;
                appData.subjects = defaultSubjects;
                appData.classes = defaultClasses;
                localStorage.setItem('master_teachers', JSON.stringify(defaultTeachers));
                localStorage.setItem('master_subjects', JSON.stringify(defaultSubjects));
                localStorage.setItem('master_classes', JSON.stringify(defaultClasses));
                renderMasterLists();
                alert("Data Reset.");
            }
        }

        // 1. UPLOAD (Admin only)
        function uploadMasterData() {
            if(!API_URL) return alert("Offline Mode");
            
            const btn = document.querySelector('#view-master .btn-submit');
            const originalText = btn.textContent;
            btn.textContent = "Menyimpan...";
            btn.disabled = true;

            const params = new URLSearchParams();
            params.append('action', 'save_master');
            params.append('teachers', JSON.stringify(appData.teachers));
            params.append('subjects', JSON.stringify(appData.subjects));
            params.append('classes', JSON.stringify(appData.classes));

            fetch(API_URL, { method: 'POST', body: params })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    showNotification("Data Master Tersimpan di Cloud!");
                    document.getElementById('master-sync-status').textContent = "Status: Tersimpan & Sinkron";
                    document.getElementById('master-sync-status').classList.remove('unsaved');
                } else {
                    alert("Gagal: " + JSON.stringify(data));
                }
            })
            .catch(err => alert("Error upload"))
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }

        // 2. DOWNLOAD (Guru & Admin)
        function downloadMasterData(verbose = false) {
            if(!API_URL) {
                if(verbose) alert("Belum setup koneksi.");
                return;
            }
            
            if(verbose) {
                const btn = document.getElementById('btn-update-guru');
                btn.textContent = "...";
                btn.disabled = true;
            }

            fetch(API_URL + '?action=get_master')
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    if(data.teachers.length > 0) appData.teachers = data.teachers;
                    if(data.subjects.length > 0) appData.subjects = data.subjects;
                    if(data.classes.length > 0) appData.classes = data.classes;
                    
                    localStorage.setItem('master_teachers', JSON.stringify(appData.teachers));
                    localStorage.setItem('master_subjects', JSON.stringify(appData.subjects));
                    localStorage.setItem('master_classes', JSON.stringify(appData.classes));
                    
                    renderMasterLists();
                    
                    if(verbose) alert("Data Terupdate!");
                }
            })
            .catch(err => console.log(err))
            .finally(() => {
                if(verbose) {
                    const btn = document.getElementById('btn-update-guru');
                    btn.textContent = "üîÑ Update Nama";
                    btn.disabled = false;
                }
            });
        }

        function renderMasterLists() {
            const render = (arr, type, id) => {
                const container = document.getElementById(id);
                container.innerHTML = '';
                arr.forEach((item, index) => {
                    container.innerHTML += `
                        <li class="master-item">
                            <span>${item}</span>
                            <button class="btn-mini" style="background:#ef4444;" onclick="deleteMasterItem('${type}', ${index})">‚úï</button>
                        </li>`;
                });
            };
            render(appData.teachers, 'teachers', 'master-teacher-list');
            render(appData.subjects, 'subjects', 'master-subject-list');
            render(appData.classes, 'classes', 'master-class-list');
        }

        function addMasterItem(type, inputId) {
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if (val) {
                appData[type].push(val);
                appData[type].sort();
                renderMasterLists();
                input.value = '';
                const status = document.getElementById('master-sync-status');
                status.textContent = "‚ö†Ô∏è Ada perubahan! Klik tombol hijau.";
                status.classList.add('unsaved');
            }
        }

        function deleteMasterItem(type, index) {
            if(confirm('Hapus data ini?')) {
                appData[type].splice(index, 1);
                renderMasterLists();
                const status = document.getElementById('master-sync-status');
                status.textContent = "‚ö†Ô∏è Ada perubahan! Klik tombol hijau.";
                status.classList.add('unsaved');
            }
        }

        // --- SETUP & LOGIN ---
        function saveSettings() {
            const url = document.getElementById('apiUrl').value.trim();
            const sUrl = document.getElementById('sheetUrl').value.trim();
            if(url) {
                localStorage.setItem('guru_api_url', url);
                API_URL = url;
                document.getElementById('connection-status').textContent = "üü¢ Online Connected";
                downloadMasterData();
            }
            if(sUrl) {
                localStorage.setItem('guru_sheet_url', sUrl);
                SHEET_URL = sUrl;
            }
            document.getElementById('setup-box').classList.add('hidden');
            document.getElementById('login-box').classList.remove('hidden');
        }

        function showSetup() {
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('setup-box').classList.remove('hidden');
        }
        
        function cancelSetup() {
             document.getElementById('setup-box').classList.add('hidden');
             document.getElementById('login-box').classList.remove('hidden');
        }

        function login(role) {
            if(role === 'guru') {
                currentUserRole = 'guru';
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('guru-nav').classList.remove('hidden');
                switchView('form');
                downloadMasterData(false);
            } else {
                document.getElementById('password-area').classList.remove('hidden');
            }
        }

        function checkAdmin() {
            if(document.getElementById('adminPass').value === ADMIN_PASS) {
                currentUserRole = 'admin';
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('admin-nav').classList.remove('hidden');
                
                if(SHEET_URL) {
                    const btn = document.getElementById('btn-open-sheet');
                    btn.href = SHEET_URL;
                    btn.classList.remove('hidden');
                }

                switchView('dashboard');
                fetchCloudData();
                downloadMasterData(false);
            } else {
                alert("Password salah!");
            }
        }

        function logout() {
            location.reload();
        }

        function switchView(view) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-master').classList.add('hidden');
            
            const adminBtns = document.querySelectorAll('#admin-nav .nav-btn');
            adminBtns.forEach(b => b.classList.remove('active'));

            document.getElementById('view-' + view).classList.remove('hidden');
            
            if(currentUserRole === 'admin') {
                if(view === 'dashboard') adminBtns[0].classList.add('active');
                if(view === 'master') adminBtns[1].classList.add('active');
            }
        }

        // --- CLOUD OPERATIONS ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            btn.disabled = true;
            btnText.textContent = "Mengirim...";
            btnLoader.classList.remove('hidden');

            const mode = document.querySelector('input[name="type"]:checked').value;
            const hours = parseInt(document.getElementById('hours').value) || 0;

            const payload = {
                action: 'insert',
                ID: Date.now(),
                Tanggal: document.getElementById('date').value,
                Waktu: document.getElementById('startTime').value,
                Guru: document.getElementById('teacherName').value,
                Status: document.getElementById('isSubstitute').checked ? 'Badal' : 'Tetap',
                Mapel: document.getElementById('subject').value,
                Kelas: document.getElementById('className').value,
                Mode: mode,
                'Jam Sendiri': mode === 'sendiri' ? hours : 0,
                'Jam Team': mode === 'berdua' ? hours : 0
            };

            if(API_URL) {
                const params = new URLSearchParams();
                for (const key in payload) { params.append(key, payload[key]); }

                fetch(API_URL, {
                    method: 'POST',
                    body: params
                })
                .then(response => response.json())
                .then(data => {
                    if(data.result === 'success') {
                        showNotification('Data Terkirim ke Cloud!');
                        resetForm();
                    } else {
                        alert('Server Gagal: ' + JSON.stringify(data));
                    }
                })
                .catch(err => { console.error(err); alert("Error Koneksi."); })
                .finally(() => {
                    btn.disabled = false;
                    btnText.textContent = "Kirim ke Cloud ‚òÅÔ∏è";
                    btnLoader.classList.add('hidden');
                });
            } else {
                alert("Mode Offline. Data tidak tersimpan.");
                btn.disabled = false;
                btnLoader.classList.add('hidden');
            }
        }

        function fetchCloudData() {
            if(!API_URL) return;
            const loader = document.getElementById('loading-indicator');
            const tbody = document.getElementById('table-body');
            loader.classList.remove('hidden');
            tbody.innerHTML = '';

            fetch(API_URL + '?action=read')
            .then(response => response.json())
            .then(json => {
                if(json.result === 'success') {
                    renderTable(json.data);
                    updateStats(json.data);
                }
            })
            .catch(err => console.error(err))
            .finally(() => loader.classList.add('hidden'));
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            data.sort((a,b) => b.ID - a.ID);

            data.forEach(row => {
                const tr = document.createElement('tr');
                const badgeClass = row.Mode === 'sendiri' ? 'badge-sendiri' : 'badge-berdua';
                const jamSendiri = parseInt(row['Jam Sendiri'] || row['Jam sendiri'] || row['jam sendiri'] || 0);
                const jamTeam = parseInt(row['Jam Team'] || row['Jam team'] || row['jam team'] || 0);
                const totalJam = jamSendiri + jamTeam;
                
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${row.Tanggal}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${row.Waktu}</div>
                    </td>
                    <td>
                        <div>${row.Guru}</div>
                        ${row.Status === 'Badal' ? '<span class="badge" style="background:#fff7ed; color:#c2410c; border:1px solid #fed7aa;">Badal</span>' : ''}
                    </td>
                    <td>
                        <div>${row.Mapel}</div>
                        <span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${row.Kelas}</span>
                    </td>
                    <td><span class="badge ${badgeClass}">${row.Mode}</span></td>
                    <td style="font-weight:bold; text-align:center;">${totalJam > 0 ? totalJam : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats(data) {
            const solo = data.reduce((sum, r) => sum + (parseInt(r['Jam Sendiri'] || r['Jam sendiri'] || r['jam sendiri'] || 0)), 0);
            const team = data.reduce((sum, r) => sum + (parseInt(r['Jam Team'] || r['Jam team'] || r['jam team'] || 0)), 0);
            const total = solo + team;
            document.getElementById('total-hours').textContent = total;
            document.getElementById('total-solo').textContent = solo;
            document.getElementById('total-team').textContent = team;
        }

        function resetForm() {
            document.getElementById('teacherName').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('className').value = '';
            document.getElementById('isSubstitute').checked = false;
        }

        function showNotification(msg) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
